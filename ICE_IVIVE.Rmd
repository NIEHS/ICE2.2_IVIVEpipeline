---
title: "ICE IVIVE workflow"
Date: 08/05/2020 Modified 08/26/2020
Note: Used ICE 3.1 and higher;relies on httk 2.0.1 
output:
    html_document
Author: ILS (comptox@ils-inc.com)
---

```{r setup1, include=FALSE}
rm(list = ls())
```


```{r setup, include=FALSE}

knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```


# Description

The workflow allows the flexibility to select from three different rat and human PK models: a 1 compartment model that incorporates Monte Carlo simulation to simulate the population variance (1C), a 3 compartment model leveraging the  [EPA's httk package](https://github.com/USEPA/CompTox-ExpoCast-httk) (Solve_3comp) and (solve_pbtk). The workflow is to predict the daily equivalent administered dose (EAD, mg/kg/day) that would lead to steady state blood concentration equivalent to the bioactive concentration from in vitro assays and compared to the predicted lowest effective levels (LELs) of in vivo assays, which is user provided

# Load libraries

```{r}
#load libraries
library(tidyverse)
library(deSolve)
library(doParallel)
library(httk) #this is needed for models: solve_3comp, solve_pbtk. The code is compatible with httk_2.0.1
 
```

# Input variables
There are several input variables needed to run the code. Some variables are model specific, as detailed.
Adjust the file paths to point to the file in your directory.
chemFile: the file containing chemical data from ICE. this has the CASRN as the first field

The model tyle and species are set here. These are used in the function calls below
```{r}
chemFile <- "ChemicalData_rnotebook.txt" # chemicals data from ICE, include CASRN field as identifier
assayFile <- "invitroData_xc.txt" # invitro data from ICE, includes CASRN field as identifier then acc/ac50 values
species <- "human" # human or rat
modelType <-  "1C" # "solve_3comp", "solve_pbtk"

output_file <- "outtest1.txt" # file name (and path) for the output file for the tissue concentrations with EAD estimations
```
For the 1 compartment model, values are needed to parameterize the Monte Carlo simulation
```{r}
nsamples <- 300 # user-provided value for the mc simulations, any number between 10 - 10,000
```
For the PBPK models some additional parameters can be modified
```{r}
route <- "oral" # oral or iv, only needed for PBPK models ("Solve_pbtk", "Solve_3comp")
interv <- 24 #dosing interval, hours, only needed for PBPK models ("Solve_pbtk", "Solve_3comp")
ndays <- 3 #number of days dosin is done, only needed for PBPK models ("Solve_pbtk", "Solve_3comp")
ConcentrationUnit <- "uM" #this is not available on the UI currently, options are uM and mg/L
```

# Load functions

```{r}
#All required R scripts and input files should be in the working directory
source("steadyState.R") # required for "1C" model
source("CalcEAD.R") # required for "1C", "solve_3comp"and "solve_pbtk"
source("EADboxplot.R")
```

# Load data

```{r}
chemical <- as.data.frame(read_delim(chemFile, delim = "\t")) #there are single quotes in chemical names that need to be addressed, the tidyR handels well
chemical[1:2,]
```

```{r}
invitro <- as.data.frame(read_delim(assayFile, delim = "\t"))
invitro[1:2,]
```

# Preparing data
Minor prep work is done on the data that comes from ICE 
Partitioning coefficients are obtained by internal function from the httk package using the provided phys chem parameters.

```{r}
## input data assigned as chemical, column names should be labeled correctly. RegEx have been used to help
## Funbound. should be fu,
# "CASRN", "DTXSID", "ChemicalName", "Species", "LogP", "Clint", "fu", "pka_Donor", "pka_Accept", "HL", "MW",       "pkidney", "pliver", "pbody", "Kgut2pu" 

#cleaning the names for taking from an ICE Query-stricter matching is used to handel including the ADME source information
colnames(chemical)<-gsub(".*Name.*", "ChemicalName", colnames(chemical))
colnames(chemical)<-gsub(".*Parameters fu.*", "fu", colnames(chemical), ignore.case =TRUE)
colnames(chemical)<-gsub(".*funbound.*", "fu", colnames(chemical), ignore.case =TRUE)
colnames(chemical)<-gsub(".*fu Source.*", "fu Source", colnames(chemical), ignore.case =TRUE)
colnames(chemical)<-gsub(".*MW.*", "MW", colnames(chemical))
colnames(chemical)<-gsub(".*HL.*", "HL", colnames(chemical))
colnames(chemical)<-gsub(".*Parameters Clint.*", "Clint", colnames(chemical), ignore.case = TRUE)
colnames(chemical)<-gsub(".*Clint Source.*", "Clint Source", colnames(chemical), ignore.case = TRUE)
colnames(chemical)<-gsub(".*LogP.*", "LogP", colnames(chemical))
colnames(chemical)<-gsub(".*pKa, Basic.*", "pka_Accept", colnames(chemical))
colnames(chemical)<-gsub(".*pKa, Acidic.*", "pka_Donor", colnames(chemical))

#Converting units for internsic clearance values
chemical$Clint<-10^chemical$Clint #this moves from log10 ul/ml/10^6 cells to just ul/ml/10^6 cells
chemical$logPwa<--1*chemical$HL #this gets the water octanal coeff

#setting up additional defaults:
if(!exists("expDose") || is.null(expDose)){
  expDose <- 1 #current calcualtions assume 1mg/kg/dose
}

```

# If modelType given by the user is "1C"
This will run a simple, 1 compartment model. In this model the C steady state is determined vs the C max from the other models

```{r}
if (modelType == "1C") {    ### modelType needs to be selected as 1C in order for this step to work 
  
  chemInput <- chemical[,c("CASRN", "ChemicalName", "Clint", "fu", "MW")] ## subsetting chemical data for columns of interest
  
  CSS <- steadyState(inputData = chemInput, nsamples = nsamples, species = species, ConcentrationUnit = ConcentrationUnit) ## for this function to work SteadyState.R should be loaded in the enviornment
  
  EAD.out50 <- CalcEAD(Css = CSS[,c("CASRN", "50%", "fu")], inVitro = invitro, adj.fu = "fu") ## CalcEAD.R should be loaded in the enviornment
  colnames(EAD.out50) <- gsub("EAD","EAD.50", colnames(EAD.out50))
  EAD.out95 <- CalcEAD(Css = CSS[,c("CASRN", "95%", "fu")], inVitro = invitro, adj.fu = "fu")
  colnames(EAD.out95) <- gsub("EAD","EAD.95", colnames(EAD.out95))
  EAD.out <- left_join(EAD.out50,EAD.out95)
  EAD.out <- EAD.out[,setdiff(colnames(EAD.out), c("adj.fu", "fu", "adj.arm","arm"))] # remove the columns "fu", adj.fu","adj.arm" and "arm"

 #creating output file, should have EAD values and the parameters for calculating the circulating concentration
  
  CSS2 <- as.data.frame(CSS, stringsAsFactors = FALSE); colnames(CSS2) <- gsub("50%", "Css, 50%ile", colnames(CSS2)); colnames(CSS2) <- gsub("95%", "Css, 95%ile", colnames(CSS2))
  CSS2$Species<-species;CSS2$Model<-"1-compartment"; CSS2$"Dose, mg/kg"<-expDose; CSS2$route<-route 
  CSS2$"nSimulations" <- nsamples
  colnames(CSS2)<-gsub("Css_Unit","Css, Units", colnames(CSS2))
  
  CSS2<-left_join(CSS2, chemical %>% select(any_of( c("CASRN","Clint Source", "fu Source"))))
  #reformatting columns to match the other models:
  CSS2<-CSS2 %>% select(any_of(c("CASRN", "ChemicalName", "Css, 50%ile","Css, 95%ile", "Css, Units", 
                                "Species","Model", "Route","Clint","Clint Source",  "fu", "fu Source" , "MW")))
 
  ssEAD.out <- EAD.out[,c("CASRN", setdiff(colnames(EAD.out), c(colnames(invitro), "50%","95%")))]
  outputData<-full_join(CSS2,ssEAD.out)
  
  write.table(outputData, file = output_file, sep = '\t', col.names = TRUE, row.names = FALSE, quote = FALSE)#output file for user
  EADplot <- EADboxplot(EAD.out = outputData,label="EAD", species = species, route = route, modelType = modelType)
  }

```


# If modelType given by the user is "solve_3comp"or "solve_pbtk"
script to run httk package models using the settings specified earlier.

```{r}
if(modelType %in% c("solve_3comp", "solve_pbtk")){
  #library(httk)
  #preprocessing variables:
  if (tolower(species) == "rat") {
    species_1 <- "Rat"
  }
  if (tolower(species) == "human") {
    species_1 <- "Human"
  }
  options(stringsAsFactors = FALSE)
  #add chemical info to the table. Using variable coming from ICE
  #to deal with mapping issues
  chemical$DTXSID2<-paste0(chemical$DTXSID, "_n")
  if(species_1=="Human"){
    chem.physical_and_invitro.data <- add_chemtable(chemical, current.table = chem.physical_and_invitro.data, data.list = list( CAS = "CASRN",DTXSID="DTXSID2",Clint = "Clint", Funbound.plasma = "fu",  pKa_Donor = 'pka_Donor', pKa_Accept = 'pka_Accept', logP = "LogP", logPwa = "logPwa", MW = "MW", logHenry="HL"), species = species_1, reference = paste0(species_1, "ICE"), overwrite = T)
  }else{
    chem.physical_and_invitro.data <- add_chemtable(chemical, current.table = chem.physical_and_invitro.data, data.list = list( CAS = "CASRN",DTXSID="DTXSID2",Clint = "Clint", Funbound.plasma = "fu",  pKa_Donor = 'pka_Donor', pKa_Accept = 'pka_Accept', logP = "LogP", logPwa = "logPwa", MW = "MW", logHenry="HL"), species = species_1, reference = paste0(species_1, "ICE"), overwrite = T)
    chem.physical_and_invitro.data <- add_chemtable(chemical, current.table = chem.physical_and_invitro.data, data.list = list( CAS = "CASRN",DTXSID="DTXSID2",Clint = "Clint", Funbound.plasma = "fu"), species = "Human", reference = paste0(species_1, "ICE"), overwrite = T) #addresses bug issues where look up from human bc assume no rat
  }
  if(route != "iv"){
    iv.dose = FALSE
  }else{iv.dose =TRUE}

  dpd<-24/interv
  cmaxall <- NULL
  # note that dose=0 per mark to stop the initial dosing of the compartments
  for(this.cas in chemical[,"CASRN"]) {
    if(modelType=="solve_3comp"){
      concMax <- max(solve_3comp(chem.cas = this.cas, parameters = NULL, doses.per.day = dpd, days = ndays,tsteps = 4,dose=0, daily.dose = expDose*dpd,iv.dose = iv.dose, output.units = ConcentrationUnit, species = species_1, default.to.human = TRUE, plots = F, suppress.messages = TRUE)[,'Cplasma'])
    }
    if(modelType=="solve_pbtk"){
      concMax <- max(solve_pbtk(chem.cas = this.cas, parameters = NULL, doses.per.day = dpd, days = ndays,tsteps = 4, dose=0, daily.dose = expDose*dpd,iv.dose = iv.dose, output.units = ConcentrationUnit, species = species_1, default.to.human = TRUE, plots = F, suppress.messages = TRUE)[,'Cplasma'])
    }

    cmax_temp <- as.data.frame(cbind(this.cas, concMax, ConcentrationUnit))
    cmaxall <- rbind(cmaxall,cmax_temp)
  }
  cmaxall$concMax <- as.numeric(cmaxall$concMax) #they are bound as characters so converting to numeric

  Cmax <- merge(chemical, cmaxall, by.x="CASRN", by.y="this.cas")
  names(Cmax) <- gsub("concMax", "Cmax", names(Cmax) )
  #Calculating the EADs
  EAD.out_max <- CalcEAD(Css = Cmax[,c("CASRN", "Cmax")], inVitro = invitro)
  EAD.out50<-EAD.out_max
  colnames(EAD.out50)<-gsub("EAD","EAD.50", colnames(EAD.out50))
  EAD.out95<-cbind(EAD.out50[1], matrix(NA, nrow=nrow(EAD.out50), ncol = ncol(EAD.out50)-1))
  colnames(EAD.out95)<-gsub("EAD.50","EAD.95", colnames(EAD.out50)) #creating a blank data object for plotting in ICE
  EAD.out<-left_join(EAD.out50,EAD.out95)
  EAD.out<-EAD.out[,setdiff(colnames(EAD.out), c("adj.fu",'fu', "arm", "adj.arm"))]
  
  
  CSS2<-as.data.frame(Cmax, stringsAsFactors=FALSE);
  #adding in the source of the parameters
  CSS2<-left_join(CSS2, chemical %>% select(any_of( c("CASRN","Clint Source", "fu Source"))))
  CSS2$Species<-species; CSS2$Model<-modelType; CSS2$"Dose, mg/kg"<-expDose;
  ssEAD.out<-EAD.out_max[,c("CASRN", setdiff(colnames(EAD.out_max), c(colnames(invitro), "Cmax")))]
  colnames(CSS2) <- gsub("ConcentrationUnit", "Cmax, Units", names(CSS2) )
  CSS2$Route <- route
  CSS2$"Dose Interval, hrs" <- interv
  CSS2$"Length of Dosing, Days" <- ndays
  #reformatting columns to match the other models:
  CSS2<-CSS2 %>% select(any_of(c("CASRN", "ChemicalName", "Cmax", "Cmax, Units", "Species","Model",
                                 "Route","Dose Interval, hrs","Length of Dosing, Days","Clint","Clint Source", "fu","fu Source" ,"MW")))
  
  outputData<-full_join(CSS2,ssEAD.out)
  write.table(outputData, file=output_file, sep='\t', col.names = TRUE, row.names = FALSE, quote = FALSE) #output file for user
  EADplot <- EADboxplot(EAD.out = outputData, label="EAD", species = species, route = route, modelType = modelType)
  }
```


```{r}
sessionInfo()
```